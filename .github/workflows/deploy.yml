name: Test & Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"   

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Show repo structure
        run: |
          pwd
          echo "== ls =="
          ls
          echo "== ls tests =="
          ls tests || echo "tests directory NOT FOUND"

      - name: Run tests with pytest
        env:
          FLASK_ENV: development
          DB_ENGINE: sqlite
          DB_NAME: test.db
          JWT_SECRET_KEY: testing-secret
        run: |
          pytest tests --maxfail=1 --disable-warnings --tb=short -vv
        
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_ec2
          chmod 600 ~/.ssh/id_ec2

          cat << EOF > ~/.ssh/config
          Host ec2
            HostName ${{ secrets.EC2_HOST }}
            User ${{ secrets.EC2_USER }}
            IdentityFile ~/.ssh/id_ec2
            StrictHostKeyChecking no
          EOF

      - name: Deploy code to EC2
        run: |
          ssh ec2 << 'EOF'
            set -e

            cd ~/app  

            echo ">> Pulling latest code..."
            git pull origin main

            echo ">> Building Docker containers..."
            docker compose build --no-cache

            echo ">> Relaunching app..."
            docker compose up -d --remove-orphans

            echo ">> Deployment complete."
          EOF
